---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dovecot
  namespace: business-system
  labels:
    app.kubernetes.io/name: dovecot
    app.kubernetes.io/component: imap-proxy
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: dovecot
      app.kubernetes.io/component: imap-proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dovecot
        app.kubernetes.io/component: imap-proxy
    spec:
      securityContext:
        fsGroup: 102  # dovecot group - allows writing to cache PVC
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: cleanup-sockets
          image: busybox:1.36
          command: ["sh", "-c", "rm -rf /run/dovecot/*"]
          volumeMounts:
            - name: run
              mountPath: /run/dovecot
      containers:
        - name: dovecot
          image: dovecot/dovecot:2.3.21
          command:
            - /bin/sh
            - -c
            - |
              # Clean stale sockets from previous container crash
              rm -rf /run/dovecot/*
              exec /usr/sbin/dovecot -F
          ports:
            - name: imap
              containerPort: 143
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/dovecot/dovecot.conf
              subPath: dovecot.conf
            - name: config
              mountPath: /etc/dovecot/conf.d/10-auth.conf
              subPath: 10-auth.conf
            - name: config
              mountPath: /etc/dovecot/conf.d/10-mail.conf
              subPath: 10-mail.conf
            - name: config
              mountPath: /etc/dovecot/conf.d/20-imapc.conf
              subPath: 20-imapc.conf
            - name: config
              mountPath: /etc/dovecot/conf.d/no-chroot.conf
              subPath: no-chroot.conf
            - name: config
              mountPath: /etc/dovecot/conf.d/10-ssl.conf
              subPath: 10-ssl.conf
            - name: credentials
              mountPath: /etc/dovecot/users
              subPath: users
              readOnly: true
            - name: cache
              mountPath: /srv/vmail
            - name: run
              mountPath: /run/dovecot
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            tcpSocket:
              port: imap
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: imap
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: true
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
              add:
                - CHOWN
                - SETGID
                - SETUID
                - NET_BIND_SERVICE
        # Sidecar for background mailbox sync
        - name: sync
          image: dovecot/dovecot:2.3.21
          command:
            - /bin/sh
            - -c
            - |
              echo "Starting sync sidecar..."

              while true; do
                echo "=== Sync run at $(date) ==="

                # Read users and sync each
                while IFS= read -r line || [ -n "$line" ]; do
                  [ -z "$line" ] && continue
                  echo "$line" | grep -q "^#" && continue

                  user="$${line%%:*}"
                  password="$${line#*:}"
                  [ -z "$user" ] && continue

                  echo "Syncing $user..."

                  # 1. Pull new mail from Migadu (one-way, won't delete local if deleted on Migadu)
                  echo "  Pulling from Migadu..."
                  doveadm -o base_dir=/run/dovecot \
                          -o first_valid_uid=101 \
                          -o first_valid_gid=102 \
                          -o imapc_host=imap.migadu.com \
                          -o imapc_port=993 \
                          -o imapc_ssl=imaps \
                          -o imapc_user="$user" \
                          -o imapc_password="$password" \
                          -o imapc_features="rfc822.size fetch-headers fetch-bodystructure" \
                          -o ssl_client_ca_dir=/etc/ssl/certs \
                          -o mail_location="mdbox:/srv/vmail/$user/mdbox" \
                          -o mail_prefetch_count=20 \
                          sync -1 -R -u "$user" imapc: 2>&1 || echo "Pull failed for $user"

                  # 2. Push local changes to Migadu (one-way, pushes deletes to Migadu)
                  echo "  Pushing to Migadu..."
                  doveadm -o base_dir=/run/dovecot \
                          -o first_valid_uid=101 \
                          -o first_valid_gid=102 \
                          -o imapc_host=imap.migadu.com \
                          -o imapc_port=993 \
                          -o imapc_ssl=imaps \
                          -o imapc_user="$user" \
                          -o imapc_password="$password" \
                          -o imapc_features="rfc822.size fetch-headers fetch-bodystructure" \
                          -o ssl_client_ca_dir=/etc/ssl/certs \
                          -o mail_location="mdbox:/srv/vmail/$user/mdbox" \
                          -o mail_prefetch_count=20 \
                          sync -1 -u "$user" imapc: 2>&1 || echo "Push failed for $user"
                done < /etc/dovecot-sync/users

                echo "=== Sync complete, sleeping 30s ==="
                sleep 30
              done
          volumeMounts:
            - name: credentials
              mountPath: /etc/dovecot-sync
              readOnly: true
            - name: cache
              mountPath: /srv/vmail
            - name: run
              mountPath: /run/dovecot
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 256Mi
          securityContext:
            runAsUser: 101
            runAsGroup: 102
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: config
          configMap:
            name: dovecot-config
        - name: credentials
          secret:
            secretName: dovecot-sync-credentials
        - name: cache
          persistentVolumeClaim:
            claimName: dovecot-cache
        - name: run
          emptyDir: {}
        - name: tmp
          emptyDir: {}
