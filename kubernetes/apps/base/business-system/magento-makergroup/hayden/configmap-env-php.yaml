---
apiVersion: v1
kind: ConfigMap
metadata:
  name: hayden-env-php
  namespace: business-system
data:
  env.php: |
    <?php
    /**
     * Kubernetes env.php - reads configuration from environment variables.
     * Non-sensitive values have sensible defaults. Secrets use getenv().
     *
     * Required env vars:
     *   MAGENTO_CRYPT_KEY, MAGENTO_DB_HOST (include port, e.g. host:3306),
     *   MAGENTO_DB_NAME, MAGENTO_DB_USER, MAGENTO_DB_PASSWORD
     *
     * Optional env vars (with defaults):
     *   MAGENTO_MODE (production),
     *   MAGENTO_ADMIN_URL (admin), MAGE_RUN_CODE, MAGE_RUN_TYPE,
     *   MAGENTO_SESSION_REDIS_HOST, MAGENTO_SESSION_REDIS_PORT (6379),
     *   MAGENTO_SESSION_REDIS_DB (5), MAGENTO_CACHE_REDIS_HOST,
     *   MAGENTO_CACHE_REDIS_PORT (6379), MAGENTO_CACHE_REDIS_DB (6),
     *   MAGENTO_PAGE_CACHE_REDIS_HOST, MAGENTO_PAGE_CACHE_REDIS_PORT (6379),
     *   MAGENTO_PAGE_CACHE_REDIS_DB (1), MAGENTO_ES_HOST, MAGENTO_ES_PORT (9200),
     *   MAGENTO_AMQP_HOST, MAGENTO_AMQP_PORT (5672),
     *   MAGENTO_AMQP_USER, MAGENTO_AMQP_PASSWORD
     */

    $dbHost = getenv('MAGENTO_DB_HOST') ?: 'localhost';
    $dbPort = getenv('MAGENTO_DB_PORT') ?: '3306';
    // Embed port in host if not already present (required by Magento MySQL adapter)
    if (strpos($dbHost, ':') === false && strpos($dbHost, '/') === false) {
        $dbHost = $dbHost . ':' . $dbPort;
    }

    return [
        'backend' => [
            'frontName' => getenv('MAGENTO_ADMIN_URL') ?: 'admin',
        ],
        'crypt' => [
            'key' => getenv('MAGENTO_CRYPT_KEY'),
        ],
        'db' => [
            'table_prefix' => '',
            'connection' => [
                'default' => [
                    'host' => $dbHost,
                    'dbname' => getenv('MAGENTO_DB_NAME') ?: 'magento',
                    'username' => getenv('MAGENTO_DB_USER') ?: 'magento',
                    'password' => getenv('MAGENTO_DB_PASSWORD'),
                    'active' => '1',
                    'model' => 'mysql4',
                    'engine' => 'innodb',
                    'initStatements' => 'SET NAMES utf8;',
                    'driver_options' => [
                        1014 => false,
                    ],
                ],
            ],
        ],
        'resource' => [
            'default_setup' => [
                'connection' => 'default',
            ],
        ],
        'x-frame-options' => 'SAMEORIGIN',
        'MAGE_MODE' => getenv('MAGENTO_MODE') ?: 'production',
        'session' => [
            'save' => 'redis',
            'redis' => [
                'host' => getenv('MAGENTO_SESSION_REDIS_HOST') ?: '127.0.0.1',
                'port' => getenv('MAGENTO_SESSION_REDIS_PORT') ?: '6379',
                'password' => getenv('MAGENTO_SESSION_REDIS_PASSWORD') ?: '',
                'timeout' => '2.5',
                'persistent_identifier' => '',
                'database' => getenv('MAGENTO_SESSION_REDIS_DB') ?: '5',
                'compression_threshold' => '2048',
                'compression_library' => 'gzip',
                'log_level' => '3',
                'max_concurrency' => '6',
                'break_after_frontend' => '5',
                'break_after_adminhtml' => '30',
                'first_lifetime' => '600',
                'bot_first_lifetime' => '60',
                'bot_lifetime' => '7200',
                'disable_locking' => '0',
                'min_lifetime' => '60',
                'max_lifetime' => '2592000',
                'sentinel_master' => getenv('MAGENTO_SESSION_REDIS_SENTINEL_MASTER') ?: '',
                'sentinel_servers' => getenv('MAGENTO_SESSION_REDIS_SENTINEL_SERVERS') ?: '',
                'sentinel_connect_retries' => '5',
                'sentinel_verify_master' => '0',
            ],
        ],
        'cache' => [
            'frontend' => [
                'default' => [
                    'id_prefix' => getenv('MAGENTO_CACHE_ID_PREFIX') ?: 'mg_',
                    'backend' => 'Cm_Cache_Backend_Redis',
                    'backend_options' => [
                        'server' => getenv('MAGENTO_CACHE_REDIS_HOST') ?: '127.0.0.1',
                        'database' => getenv('MAGENTO_CACHE_REDIS_DB') ?: '6',
                        'port' => getenv('MAGENTO_CACHE_REDIS_PORT') ?: '6379',
                        'password' => getenv('MAGENTO_CACHE_REDIS_PASSWORD') ?: '',
                        'sentinel_master' => getenv('MAGENTO_CACHE_REDIS_SENTINEL_MASTER') ?: '',
                        'sentinel_servers' => getenv('MAGENTO_CACHE_REDIS_SENTINEL_SERVERS') ?: '',
                        'sentinel_connect_retries' => '5',
                        'sentinel_verify_master' => '0',
                    ],
                ],
                'page_cache' => [
                    'id_prefix' => getenv('MAGENTO_CACHE_ID_PREFIX') ?: 'mg_',
                    'backend' => 'Magento\\Framework\\Cache\\Backend\\Redis',
                    'backend_options' => [
                        'server' => getenv('MAGENTO_PAGE_CACHE_REDIS_HOST') ?: '127.0.0.1',
                        'database' => getenv('MAGENTO_PAGE_CACHE_REDIS_DB') ?: '1',
                        'port' => getenv('MAGENTO_PAGE_CACHE_REDIS_PORT') ?: '6379',
                        'password' => getenv('MAGENTO_PAGE_CACHE_REDIS_PASSWORD') ?: '',
                        'sentinel_master' => getenv('MAGENTO_PAGE_CACHE_REDIS_SENTINEL_MASTER') ?: '',
                        'sentinel_servers' => getenv('MAGENTO_PAGE_CACHE_REDIS_SENTINEL_SERVERS') ?: '',
                        'sentinel_connect_retries' => '5',
                        'sentinel_verify_master' => '0',
                        'compress_data' => '0',
                        'compression_lib' => '',
                    ],
                ],
            ],
            'allow_parallel_generation' => false,
        ],
        'cache_types' => [
            'config' => 1,
            'layout' => 1,
            'block_html' => 1,
            'collections' => 1,
            'reflection' => 1,
            'db_ddl' => 1,
            'compiled_config' => 1,
            'eav' => 1,
            'customer_notification' => 1,
            'config_integration' => 1,
            'config_integration_api' => 1,
            'full_page' => 1,
            'config_webservice' => 1,
            'translate' => 1,
            'vertex' => 1,
            'amasty_shopby' => 1,
            'google_product' => 1,
        ],
        'system' => [
            'default' => [
                'catalog' => [
                    'search' => [
                        'engine' => 'elasticsearch7',
                        'elasticsearch7_server_hostname' => getenv('MAGENTO_ES_HOST') ?: 'localhost',
                        'elasticsearch7_server_port' => getenv('MAGENTO_ES_PORT') ?: '9200',
                        'elasticsearch7_index_prefix' => getenv('MAGENTO_ES_INDEX_PREFIX') ?: 'magento2',
                        'elasticsearch7_enable_auth' => '0',
                        'elasticsearch7_server_timeout' => '15',
                    ],
                ],
            ],
        ],
        'queue' => [
            'amqp' => [
                'host' => getenv('MAGENTO_AMQP_HOST') ?: '',
                'port' => getenv('MAGENTO_AMQP_PORT') ?: '5672',
                'user' => getenv('MAGENTO_AMQP_USER') ?: '',
                'password' => getenv('MAGENTO_AMQP_PASSWORD') ?: '',
                'virtualhost' => getenv('MAGENTO_AMQP_VIRTUALHOST') ?: '/',
            ],
            'consumers_wait_for_messages' => 0,
        ],
        'lock' => [
            'provider' => 'db',
        ],
        'directories' => [
            'document_root_is_pub' => true,
        ],
        'remote_storage' => [
            'driver' => 'file',
        ],
        'config' => [
            'async' => 0,
        ],
        'install' => [
            'date' => 'Sat, 01 Jan 2022 00:00:00 +0000',
        ],
    ];
