---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dovecot-sync
  namespace: business-system
  labels:
    app.kubernetes.io/name: dovecot
    app.kubernetes.io/component: sync
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  concurrencyPolicy: Forbid  # Don't run if previous still running
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 300  # 5 min timeout
      template:
        spec:
          restartPolicy: OnFailure
          securityContext:
            fsGroup: 102
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: sync
              image: dovecot/dovecot:2.3.21
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "Starting mailbox sync at $(date)"

                  # Read users file and sync each
                  while IFS=: read -r user password; do
                    # Skip empty lines and comments
                    [ -z "$user" ] && continue
                    echo "$user" | grep -q "^#" && continue

                    echo "Syncing $user..."
                    doveadm -o imapc_host=imap.migadu.com \
                            -o imapc_port=993 \
                            -o imapc_ssl=imaps \
                            -o imapc_user="$user" \
                            -o imapc_password="$password" \
                            -o imapc_features="rfc822.size fetch-headers fetch-bodystructure" \
                            -o ssl_client_ca_dir=/etc/ssl/certs \
                            -o mail_location="imapc:/srv/vmail/$user/imapc" \
                            -o mail_prefetch_count=20 \
                            sync -1 -R -u "$user" imapc: || echo "Sync failed for $user"

                    echo "Completed $user"
                  done < /etc/dovecot-sync/users

                  echo "All syncs complete at $(date)"
              volumeMounts:
                - name: credentials
                  mountPath: /etc/dovecot-sync
                  readOnly: true
                - name: cache
                  mountPath: /srv/vmail
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  memory: 256Mi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: credentials
              secret:
                secretName: dovecot-sync-credentials
            - name: cache
              persistentVolumeClaim:
                claimName: dovecot-cache
